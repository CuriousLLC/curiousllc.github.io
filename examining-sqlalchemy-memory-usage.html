<!DOCTYPE html>
<html lang="en">
<head>
  <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,400italic' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" type="text/css" href="/theme/css/style.min.css">
  <link rel="stylesheet" type="text/css" href="/theme/css/pygments.min.css">
  <link rel="stylesheet" type="text/css" href="/theme/css/font-awesome.min.css">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="" />
<meta name="author" content="ryanday" />
<meta name="description" content="Locate large memory structure in SQLAlchemy" />
<meta name="keywords" content="">
<meta property="og:site_name" content="Working with hardware"/>
<meta property="og:title" content="Examining SQLAlchemy Memory Usage"/>
<meta property="og:description" content="Locate large memory structure in SQLAlchemy"/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="/examining-sqlalchemy-memory-usage.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2015-03-20 18:22:00-04:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="/author/ryanday.html">
<meta property="article:section" content="sqlalchemy python"/>
<meta property="og:image" content="https://avatars3.githubusercontent.com/u/6845642?v=3&s=200">  <title>Working with hardware &ndash; Examining SQLAlchemy Memory Usage</title>
</head>
<body>
  <aside>
    <div>
      <a href="">
        <img src="https://avatars3.githubusercontent.com/u/6845642?v=3&s=200" alt="" title="">
      </a>
      <h1><a href=""></a></h1>
      <p></p>
      <nav>
        <ul class="list">
          <li><a href="http://curiousllc.com/" target="_blank">Curious LLC</a></li>
          <li><a href="http://www.meetup.com/NOVA-Python" target="_blank">Nova Python</a></li>
          <li><a href="http://www.meetup.com/Golang-DC/" target="_blank">Golang DC</a></li>
        </ul>
      </nav>
      <ul class="social">
        <li><a class="sc-You can add links in your config file" href="#" target="_blank"><i class="fa fa-You can add links in your config file"></i></a></li>
        <li><a class="sc-Another social link" href="#" target="_blank"><i class="fa fa-Another social link"></i></a></li>
      </ul>
    </div>
  </aside>
  <main>

<article>
  <header>
    <h1 id="examining-sqlalchemy-memory-usage">Examining SQLAlchemy Memory Usage</h1>
    <p>Posted on Fri 20 March 2015 in <a href="/category/sqlalchemy-python.html">sqlalchemy python</a></p>
  </header>
  <div>
    <p>I started having segfaults in my celery processes. These were incredibly difficult to debug because they didn’t always happen, and never happened in development. Fortunately they were happening in certain places and I was able to guess where the problem was. However, I didn’t understand just how severe the problem was.</p>
<p>I use SQLAlchemy in my Flask apps. I typically issue queries similar to</p>
<p>query_result = db.session.query(MyModel).first()</p>
<p>I knew I was running out of memory on my entry level Digital Ocean droplets.
That is when the segfaults started. I stumbled across <a class="reference external" href="https://pypi.python.org/pypi/memory_profiler">Memory Profiler</a> and
created a quick test program to profile a single function that was causing problems.</p>
<div class="highlight"><pre>Line # Mem usage Increment Line Contents
================================================
56 46.0 MiB 0.0 MiB   @profile
57                    def get_bounced_emails():
58 48.2 MiB 2.2 MiB       emails = db.session.query(EmailAddress).\
59 48.3 MiB 0.0 MiB           join(send_history, send_history.c.email_id == EmailAddress.email_id).\
60 372.1 MiB 323.9 MiB        filter(send_history.c.bounce == 1).\
61                            all()
62
63 372.1 MiB 0.0 MiB      email_dict = {}
64 374.1 MiB 2.0 MiB      for email in emails:
65 374.1 MiB 0.0 MiB          email_dict[email.email_address] = True
66
67 314.9 MiB -59.2 MiB    del emails
68 314.9 MiB 0.0 MiB      return email_dict
</pre></div>
<p>The memory profiler package makes it real easy to see the memory consumption of your application line by line. In this function, we are just retrieving a ton of records. They are taking up a lot of memory.</p>
<p>This is where I learned a little bit about SQLAlchemy. This function only needs the email_address field of the record, but I’m retrieving the entire record. So I made a change to simply grab the email_address record.</p>
<div class="highlight"><pre>Line # Mem usage Increment Line Contents
================================================
56 46.0 MiB 0.0 MiB   @profile
57                    def get_bounced_emails():
58 47.1 MiB 1.1 MiB       emails = db.session.query(EmailAddress.email_address).\
59 47.1 MiB 0.0 MiB           join(send_history, send_history.c.email_id == EmailAddress.email_id).\
60 81.2 MiB 34.1 MiB          filter(send_history.c.bounce == 1).\
61                            all()
62
63 81.2 MiB 0.0 MiB       email_dict = {}
64 84.2 MiB 3.0 MiB       for email in emails:
65 84.2 MiB 0.0 MiB           email_dict[email[0]] = True
66
67 65.9 MiB -18.2 MiB     del emails
68 65.9 MiB 0.0 MiB       return email_dict
</pre></div>
<p>Wow. By just grabbing that one field I seriously reduced the memory consumption of this method. I had under estimated just how much overhead there is in pulling the entire record in a query.</p>
<p>Now I take this into account when building queries. Just what do I need form the DB? Then I only grab that.</p>

  </div>
  <div class="tag-cloud">
    <p>
    </p>
  </div>
</article>

    <footer>
      <p>&copy; Ryan Day </p>
<p>Built using <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a></p>    </footer>
  </main>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BlogPosting",
  "name": "Examining SQLAlchemy Memory Usage",
  "headline": "Examining SQLAlchemy Memory Usage",
  "datePublished": "2015-03-20 18:22:00-04:00",
  "dateModified": "",
  "author": {
    "@type": "Person",
    "name": "ryanday",
    "url": "/author/ryanday.html"
  },
  "image": "https://avatars3.githubusercontent.com/u/6845642?v=3&s=200",
  "url": "/examining-sqlalchemy-memory-usage.html",
  "description": "Locate large memory structure in SQLAlchemy"
}
</script></body>
</html>